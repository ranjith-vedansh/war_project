name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - patch-1
      - pre-production

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}

      # Step 2: Build the WAR file
      - name: Build WAR File
        run: |
          echo "Building WAR file from source code"
          mvn clean package
          ls -lrt target

      # Step 3: Run Unit Tests
      - name: Run Unit Tests
        run: |
          echo "Executing Unit Tests"
          # Uncomment the following line to enable tests
          # mvn test

      # Step 4: Deploy based on branch
      - name: Deploy WAR File
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "Deploying WAR to remote Web Server"
          
          # Determine the server based on the branch
          if [ "${{ github.ref_name }}" == "master" ]; then
            SERVER_IP="13.233.145.108"
          elif [ "${{ github.ref_name }}" == "patch-1" ]; then
            SERVER_IP="13.233.145.200"
          elif [ "${{ github.ref_name }}" == "pre-production" ]; then
            SERVER_IP="13.233.145.300"
          else
            echo "Branch not configured for deployment: ${{ github.ref_name }}"
            exit 1
          fi

          echo "Deploying to server: $SERVER_IP"

          # Add the SSH key to the agent
          echo "$SSH_PRIVATE_KEY" | ssh-add -

          # Deploy the WAR file
          ssh -o StrictHostKeyChecking=no ubuntu@$SERVER_IP ls -lrt
          scp -o StrictHostKeyChecking=no target/*.war ubuntu@$SERVER_IP:/opt/tomcat/webapps/
          echo "âœ… Copy completed successfully."
          ssh ubuntu@$SERVER_IP "sudo systemctl restart tomcat"
