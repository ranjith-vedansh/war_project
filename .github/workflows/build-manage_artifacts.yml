name: Build and Manage Artifacts for Java Application
on:
  workflow_dispatch:
    inputs:
      decide_version:
        description: 'Accept type of artifact'
        required: true
        type: choice
        options:
          - Snapshot
          - Minor
          - Release
        default: Snapshot
    
  push:
    branches:
      - main
      - pre-production

env:
  Snapshot: 0.0.1
  Minor: 0.1.0
  Release: 1.0.0

jobs:
  Java_CI_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install pre-requisite (Java and Maven)
        run: |
          echo "Verify Java installation"   >> $GITHUB_STEP_SUMMARY
          if ! command -v java &> /dev/null
          then
              echo "Java not found. Installing OpenJDK..."   >> $GITHUB_STEP_SUMMARY
              sudo apt-get update
              sudo apt-get install -y openjdk-17-jdk
          else
              echo "Java is already installed:"   >> $GITHUB_STEP_SUMMARY
              java --version
          fi
  
          echo "Verify Maven installation"   >> $GITHUB_STEP_SUMMARY
          if ! command -v mvn &> /dev/null
          then
              echo "Maven not found. Installing Maven..."   >> $GITHUB_STEP_SUMMARY
              sudo apt-get update
              sudo apt-get install -y maven
          else
              echo "Maven is already installed:"   >> $GITHUB_STEP_SUMMARY
              mvn --version
          fi
          
      - name: Bump Version based on User Input
        if: github.event_name == 'workflow_dispatch'
        run: |
          # 1. Get current version from pom.xml
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version is: $CURRENT_VERSION"
          
          # 2. Logic to determine new version
          # This uses the 'decide_version' input from your workflow
          CHOICE="${{ github.event.inputs.decide_version }}"
          
          if [ "$CHOICE" == "Snapshot" ]; then
            # Adds -SNAPSHOT suffix if not present
            NEW_VERSION="${CURRENT_VERSION%-SNAPSHOT}-SNAPSHOT"
          elif [ "$CHOICE" == "Minor" ]; then
            # Logic to increment the middle digit (e.g., 1.2.3 -> 1.3.0)
            BASE=$(echo $CURRENT_VERSION | cut -d'-' -f1)
            MAJOR=$(echo $BASE | cut -d. -f1)
            MINOR=$(echo $BASE | cut -d. -f2)
            NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
          elif [ "$CHOICE" == "Release" ]; then
            # Removes -SNAPSHOT for a clean release (e.g., 1.2.0-SNAPSHOT -> 1.2.0)
            NEW_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')
          fi

          echo "Bumping version to: $NEW_VERSION"
          
          # 3. Apply the new version to pom.xml
          mvn versions:set -DnewVersion=$NEW_VERSION -DgenerateBackupPoms=false
          
          # 4. Export for later steps (optional)
          echo "FINAL_VERSION=$NEW_VERSION" >> $GITHUB_ENV
      
      
      - name: Build the application
        run: |
          mvn clean package
          echo "List of Files and Dirs"   >> $GITHUB_STEP_SUMMARY
          ls -lrt   >> $GITHUB_STEP_SUMMARY
