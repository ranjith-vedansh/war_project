name: Build and Manage Artifacts for Java Application

on:
  workflow_dispatch:
    inputs:
      decide_version:
        description: 'Select the type of version bump'
        required: true
        type: choice
        options:
          - Snapshot
          - Minor
          - Release
        default: Snapshot
    
  push:
    branches:
      - main
      - pre-production

jobs:
  Java_CI_job:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up JDK 17 and Maven Settings
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          # This creates a settings.xml. We use a dummy ID here because 
          # we will handle the specific server IDs in the next step.
          server-id: nexus-releases
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD

      - name: Configure Maven Settings for Nexus
        # This step ensures both Release and Snapshot IDs have the credentials
        run: |
          mkdir -p ~/.m2
          echo "<settings>
            <servers>
              <server>
                <id>nexus-releases</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
              <server>
                <id>nexus-snapshots</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>" > ~/.m2/settings.xml

      - name: Bump Version and Commit to Git
        if: github.event_name == 'workflow_dispatch'
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          CHOICE="${{ github.event.inputs.decide_version }}"
          BASE=$(echo $CURRENT_VERSION | cut -d'-' -f1)
          MAJOR=$(echo $BASE | cut -d. -f1)
          MINOR=$(echo $BASE | cut -d. -f2)

          if [ "$CHOICE" == "Minor" ]; then
            NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
          elif [ "$CHOICE" == "Release" ]; then
            NEW_VERSION="$BASE"
          else
            NEW_VERSION="${BASE}-SNAPSHOT"
          fi

          mvn versions:set -DnewVersion=$NEW_VERSION -DgenerateBackupPoms=false

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add pom.xml
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: bump version to $NEW_VERSION [skip ci]" && git push)

      - name: Build and Deploy to Nexus
        run: |
          # Added -e for error visibility and --settings to ensure it uses our custom file
          mvn clean deploy -DskipTests -e
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Build Summary
        if: always()
        run: |
          FINAL_VER=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "### Build Result" >> $GITHUB_STEP_SUMMARY
          echo "* **Artifact Version:** $FINAL_VER" >> $GITHUB_STEP_SUMMARY
          echo "* **Nexus IP:** 13.232.124.242" >> $GITHUB_STEP_SUMMARY
